# Nginx reverse proxy configuration for agentic voice assistant
# Enables HTTPS access from mobile devices for WebRTC

# Custom PID file location (avoids /run/nginx.pid permission issues)
pid /home/rodrigo/agentic/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # Custom log locations (avoids /var/log/nginx permission issues)
    access_log /home/rodrigo/agentic/logs/nginx-access.log;
    error_log /home/rodrigo/agentic/logs/nginx-error.log;
    # Upstream servers
    upstream frontend {
        server localhost:3000;
    }

    upstream backend {
        server localhost:8000;
    }

    # HTTPS server
    server {
        listen 443 ssl;
        server_name _;

        # SSL certificate paths
        ssl_certificate /home/rodrigo/agentic/ssl/nginx-selfsigned.crt;
        ssl_certificate_key /home/rodrigo/agentic/ssl/nginx-selfsigned.key;

        # SSL configuration
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Frontend (React app)
        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;

            # DISABLE caching for development (mobile cache issue fix)
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
            add_header Last-Modified "" always;
            if_modified_since off;
            etag off;
            proxy_cache_bypass $http_pragma;
            proxy_no_cache 1;
        }

        # Backend API (FastAPI)
        location /api {
            proxy_pass http://backend/api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
        }

        # WebSocket endpoints (explicit handling)
        location /api/realtime-voice {
            proxy_pass http://backend/api/realtime-voice;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 86400;
        }

        # WebRTC signaling WebSocket (NEW - for mobile voice)
        location /api/realtime/webrtc-signal/ {
            proxy_pass http://backend/api/realtime/webrtc-signal/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
        }

        # Old WebRTC signaling (deprecated, kept for compatibility)
        location /api/webrtc-signal/ {
            proxy_pass http://backend/api/webrtc-signal/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
        }

        location /api/runs/ {
            proxy_pass http://backend/api/runs/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 86400;
        }

        # Voice conversation stream WebSocket (removed from /api/ general proxy)
        # This is actually handled by the general /api/ location block below

        # Mobile audio relay WebSocket (removed from /api/ general proxy)
        # This is actually handled by the general /api/ location block below
    }

    # HTTP redirect to HTTPS - DISABLED (port 80 already in use)
    # If you need HTTP redirect, stop the service using port 80 first:
    # sudo lsof -i :80
    # Then uncomment below:
    #
    # server {
    #     listen 80;
    #     server_name _;
    #     return 301 https://$host$request_uri;
    # }
}
